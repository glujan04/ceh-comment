
{% resource 'ckanext_comment/jquery.validate.js' %}
{% resource 'ckanext_comment/ceh.js' %}
{% resource 'ckanext_comment/ceh.css' %}

{% macro comment_form(values={}, empty=False, hidden=True, prefix="", action="add") %}
    <form id="{{ prefix + values.id }}" class="form {% if hidden %}hidden{% endif %}" action="{{ pkg_id }}/comments/{% if values.id %}{{ values.id }}/{% endif %}{{ action }}" method="POST">
        <div class="{{ action }}_form_errors form-errors alert alert-error hidden">
            <div class="hidden error-comment">{{ _('Please enter a Comment.') }}</div>
        </div>
        <div class="form-controls">
            <label for="subject">{{ _('Subject') }}</label>
            <input type="text" class="form-control" name="subject" {% if not empty %}value="{{ values.subject }}" {% endif %}/>
            <label for="comment">{{ _('Comment') }}</label>
            {% set unescaped_content = values.content.split('<br/>') %}
            <textarea name="comment" class="form-control" rows="10">{% if not empty %}{% for line in unescaped_content %}{{ line | striptags }}{{'\n'}}{% endfor %}{% endif %}</textarea>
        </div>
        <div class="form-actions">
            <input type="submit" class="btn btn-primary" value="{{ _('Save') }}"/>
            <input type="reset" class="btn" value="{{ _('Clear') }}"/>
        </div>
    </form>
{% endmacro %}



{% set thread = h.get_comment_thread(pkg_name) %}

{% macro comment_thread(thread) %}

    <div class="comment-wrapper">
    {% for comment in thread.comments %}
        {{ comment.id }}
        <div class="comment">
            {% if comment.state != 'deleted' %}
                <h3>{{ comment.subject }}</h3>
            {% else %}
                <h3>{{ _('This comment was deleted.') }}</h3>
            {% endif %}
            <div class="submitted">
                <span>{{ h.render_datetime(comment.creation_date, "%d.%m.%Y %H:%M") }} {{  h.linked_user(comment.user_id, 0, 10) }}</span>
                {% if comment.modified_date %}
                    <br/><span>{{ h.render_datetime(comment.modified_date, "%d.%m.%Y %H:%M") }} {{ _('Modified') }} </span>
                {% endif %}
            </div>
            <div class="content">
            {% if comment.state != 'deleted' %}
                {{ comment.content|safe }}
            {% else %}
                {{ _('This comment was deleted.') }}
            {% endif %}
            {% if comment.state == 'active' %}
            <ul class="links list-inline">
                {% if h.check_access('package_update', {'id': pkg_id }) %}
                    <li><a href="/dataset/{{ pkg_id }}/comments/{{ comment.id }}/delete">{{ _('Delete') }}</a> </li>
                {% endif %}

                {% if userobj and comment.user_id == userobj.id %}
                    <li><a onclick="ShowCommentForm('edit_{{ comment.id }}')">{{ _('Edit') }}</a></li>
                    {{ comment_form(comment, prefix='edit_', action='edit') }}
                {% endif %}
                {% if userobj %}
                    <li><a onclick="ShowCommentForm('reply_{{ comment.id }}')">{{ _('Reply') }}</a> </li>
                    {{ comment_form(comment, empty=True, prefix='reply_', action='reply') }}
                {% endif %}

            </ul>
            {% endif %}
            </div>
        </div>
            {% if comment.comments | length != 0 %}
                {{ comment_thread(comment) }}
            {% endif %}
    {% endfor %}
    </div>

{% endmacro %}
<h3 id="comments">{{ _('Comments') }}</h3>
<div class="comment-container">
    {{ comment_thread(thread) }}
</div>

{# {% if userobj %} #}
<section class="additional-info">
<form class="form" action="{{ pkg_id }}/comments/add" method="post">
    <div id="comment_form_errors" class="alert alert-error form-errors hidden">
        <div class="hidden error-comment">{{ _('Please enter a Comment.') }}</div>
    </div>
    <div class="form-controls">
        <label for="subject">{{ _('Subject') }}</label>
        <input type="text" class="form-control" name="subject"/>

        <label for="comment">{{ _('Comment') }}</label>
        <textarea name="comment" class="form-control" rows="10"></textarea>
    </div>
    <div class="form-actions">
        <input type="submit" class="btn btn-primary" value="{{ _('Save') }}"/>
        <input type="reset" class="btn" value="{{ _('Clear') }}"/>
    </div>
</form>
  <h3>Agregar Comentario</h3> 
  <div class="module-content ceh-comments">
    <form action="" method="post" class="form-horizontal" id="cehCommentForm" name="cehCommentForm" role="form"> 
      <div class="form-group form-group_ech">
        <label for="cehname" class="col-sm-2 control-label">Nombre</label>
        <div class="col-sm-10 ech-col">
          <input type="text" class="form-control form-control_ech" name="cehname" id="cehname" maxlength="50" required>
        </div>
      </div>
      <div class="form-group form-group_ech">
        <label for="cehemail" class="col-sm-2 control-label">Correo</label>
        <div class="col-sm-10 ech-col">
          <input type="text" class="form-control form-control_ech" name="cehemail" id="cehemail" maxlength="30" required>
        </div>
      </div>
      <div class="form-group form-group_ech">
        <label for="cehcomment" class="col-sm-2 control-label">Comentario</label>
        <div class="col-sm-10">
          <span class="form-control_label_ech1">
            <i class="fa fa-question-circle"></i>
            <a class="ceh-tips" href="#" data-toggle="modal" data-target="#tipsModal">formatos y textos</a>
          </span>
          <textarea class="form-control form-control_label_ech1" name="cehcomment" id="cehcomment" rows="5" style="margin: 0px; height: 105px; width: 657px;" maxlength="500" required>
          </textarea>
          <span class="countdown"></span>
        </div>
      </div>
      <div class="form-group form-group_ech">
        <div class="col-sm-offset-2 col-sm-10 ech-col">
          <input type="checkbox" class="form-checkbox-input" name="cehpolicy" id="cehpolicy">
          <span class="form-checkbox-label form-control_label_ech1" for="cehpolicy">He leído y acepto los <a href="#" data-toggle="modal" data-target="#termsModal">Términos y Condiciones</a></span>
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-offset-2 col-sm-10">
          <button class="btn btn-success btn-circle text-uppercase" type="submit" id="submitComment"><span class="fa fa-paper-plane"></span> Agregar Comentario</button>
        </div>
      </div>
    </form>
<!-- Modal Terms and Conditions -->
<div class="modal fade" id="termsModal" tabindex="-1" role="dialog" aria-labelledby="termsConditionLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="termsConditionLabel">Términos y Condiciones</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <h5>RESPONSABLE</h5>
          <p>Cabildo de El Hierro</p>
          <hr>
<h5>FINALIDAD PRINCIPAL</h5>
          <p>Recogida de comentarios y sugerencias de los usuarios del Portal de Datos Abiertos de cada a desarrollar mejoras del servicio y obtener una experiencia de usuario mejorada.</p>
          <hr>
<h5>LEGITIMACIÓN</h5>
          <p>Mediante consentimiento del Interesado</p>
          <hr>
<h5>DESTINATARIOS</h5>
          <p>No se cederán datos a terceros, salvo autorización expresa u obligación legal</p>
          <hr>
<h5>DERECHOS</h5>
          <p>Acceder, rectificar y suprimir los datos, portabilidad de los datos, limitación u oposición a su tratamiento, transparencia y derecho a no ser objeto de decisiones automatizadas.</p>
          <hr>
<h5>INFORMACIÓN ADICIONAL</h5>
          <p>Puede consultar la información adicional y detallada sobre nuestra Política de Privacidad.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal Tips -->
<div class="modal fade" id="tipsModal" tabindex="-1" role="dialog" aria-labelledby="tipsLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tipsLabel">Algunos consejos</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <ul>
            <li>No se permiten etiquetas HTML.</li>
            <li>Las líneas y los párrafos se reconocen automáticamente. Las etiquetas de salto de línea &lt;br /&gt;, &lt;p&gt; párrafo y &lt;/p&gt; cerrar párrafo se insertan automáticamente. Si no se reconocen los párrafos, simplemente agregue un par de líneas en blanco.</li>
            <li>Las direcciones de las páginas web y las direcciones de correo electrónico se convierten en enlaces automáticamente.</li>
            </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
</section>
{#
{% else %}
    {{ _('Login to comment.') }}
{% endif %}
#}